{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 py-8 max-w-7xl">
    <div class="mb-8">
        <h1 class="text-3xl font-bold mb-4">Model Performance Testing</h1>
        <div class="flex items-center gap-4 text-sm text-base-content/70">
            <a href="/detections" class="link link-primary">‚Üê Back to Detections</a>
            <span>‚Ä¢</span>
            <span>Detection #{{ detection.id }}</span>
            <span>‚Ä¢</span>
            <span>{{ detection.device.name if detection.device else 'Unknown Camera' }}</span>
        </div>
    </div>

    <!-- Original Detection Info -->
    <div class="card bg-base-200 mb-8">
        <div class="card-body">
            <h2 class="card-title mb-4">Test Image</h2>
            <div class="flex flex-col lg:flex-row gap-6">
                <div class="lg:w-1/3">
                    <img src="{{ get_base_url(request) }}/{{ detection.image_path }}" 
                         alt="Detection {{ detection.id }}"
                         class="w-full rounded-lg shadow-lg">
                </div>
                <div class="lg:w-2/3">
                    <h3 class="font-bold mb-2">Original Detection Info</h3>
                    <div class="space-y-2 text-sm">
                        <div><span class="font-medium">Timestamp:</span> {{ format_datetime_tz(detection.timestamp, timezone) }}</div>
                        <div><span class="font-medium">Status:</span> <span class="badge badge-sm badge-success">{{ detection.status }}</span></div>
                        {% if detection.foes %}
                        <div>
                            <span class="font-medium">Detected Foes:</span>
                            {% for foe in detection.foes %}
                            <span class="badge badge-sm badge-warning ml-1">{{ foe.foe_type }} ({{ "%.0f%%" | format(foe.confidence * 100) }})</span>
                            {% endfor %}
                        </div>
                        {% endif %}
                        {% if detection.ai_response and detection.ai_response.performance_metrics %}
                        <div>
                            <span class="font-medium">Original Processing Time:</span>
                            <span class="font-mono">{{ detection.ai_response.performance_metrics.total_processing_ms }}ms</span>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Model Selection -->
    <div class="card bg-base-100 shadow-xl mb-8">
        <div class="card-body">
            <h2 class="card-title mb-4">Select Models to Test</h2>
            <!-- Ollama Models Section -->
            {% if available_models.ollama %}
            <div class="mb-6">
                <h3 class="font-bold text-lg mb-3 flex items-center gap-2">
                    <svg class="w-5 h-5 text-primary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 3v2m6-2v2M9 19v2m6-2v2M5 9H3m2 6H3m18-6h-2m2 6h-2M7 19h10a2 2 0 002-2V7a2 2 0 00-2-2H7a2 2 0 00-2 2v10a2 2 0 002 2zM9 9h6v6H9V9z" />
                    </svg>
                    Local Ollama Models
                </h3>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                    {% for model in available_models.ollama %}
                    {% if model.name == "no-models-found" %}
                    <div class="col-span-full bg-warning/10 border border-warning rounded-lg p-6 text-center">
                        <div class="text-warning mb-2">
                            <svg class="w-8 h-8 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 18.5c-.77.833.192 2.5 1.732 2.5z" />
                            </svg>
                        </div>
                        <h4 class="font-bold text-lg mb-2">No Local Vision Models Found</h4>
                        <p class="text-sm text-base-content/70 mb-4">No vision-capable models are installed in Ollama.</p>
                        <div class="bg-base-100 rounded-lg p-4 text-left">
                            <div class="font-medium mb-2">Quick Install Commands:</div>
                            <div class="font-mono text-xs space-y-1">
                                <div># Ultra fast for M4 Mac</div>
                                <div class="text-primary">ollama pull llava-phi3:3.8b-mini-q4_0</div>
                                <div># Alternative fast model</div>
                                <div class="text-primary">ollama pull moondream:1.8b-v2-q4_0</div>
                            </div>
                        </div>
                    </div>
                    {% else %}
                    <label class="flex items-start gap-3 p-3 bg-base-200 rounded-lg cursor-pointer hover:bg-base-300 transition-colors">
                        <input type="checkbox" class="checkbox checkbox-primary" value="{{ model.name }}" 
                               data-model-name="{{ model.name }}" onchange="toggleModel(this)">
                        <div class="flex-1">
                            <div class="font-medium">{{ model.name }}</div>
                            <div class="text-sm text-base-content/70">{{ model.description }}</div>
                            {% if model.size_gb %}
                            <div class="text-xs text-base-content/50 mt-1">{{ model.size_gb }}GB ‚Ä¢ Local ‚Ä¢ Free</div>
                            {% endif %}
                        </div>
                        <div class="model-status" id="status-{{ model.name.replace(':', '-').replace('.', '-') }}">
                            <span class="text-success text-sm">‚úì Installed</span>
                        </div>
                    </label>
                    {% endif %}
                    {% endfor %}
                </div>
            </div>
            {% endif %}

            <!-- Cloud Models Section -->
            {% if available_models.cloud %}
            <div class="mb-6">
                <h3 class="font-bold text-lg mb-3 flex items-center gap-2">
                    <svg class="w-5 h-5 text-secondary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.25 15a4.5 4.5 0 004.5 4.5H18a3.75 3.75 0 001.332-7.257 3 3 0 00-3.758-3.848 5.25 5.25 0 00-10.233 2.33A4.502 4.502 0 002.25 15z" />
                    </svg>
                    Cloud AI Models
                </h3>
                
                <!-- Group models by provider -->
                {% for provider_name, provider_data in available_models.cloud.items() %}
                <div class="mb-4">
                    <h4 class="font-semibold text-base mb-2 text-secondary">{{ provider_data.display_name }}</h4>
                    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
                        {% for model in provider_data.models %}
                        <label class="flex items-start gap-3 p-3 bg-secondary/10 border border-secondary/20 rounded-lg cursor-pointer hover:bg-secondary/20 transition-colors">
                            <input type="checkbox" class="checkbox checkbox-secondary" value="{{ model.name }}" 
                                   data-model-name="{{ model.name }}" onchange="toggleModel(this)">
                            <div class="flex-1">
                                <div class="font-medium">{{ model.display_name }}</div>
                                <div class="text-sm text-base-content/70">{{ model.description }}</div>
                            </div>
                            <div class="model-status">
                                <span class="text-secondary text-sm">‚òÅÔ∏è Ready</span>
                            </div>
                        </label>
                        {% endfor %}
                    </div>
                </div>
                {% endfor %}
            </div>
            {% endif %}

            {% if not available_models.ollama and not available_models.cloud %}
            <div class="bg-warning/10 border border-warning rounded-lg p-6 text-center">
                <div class="text-warning mb-2">
                    <svg class="w-8 h-8 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-2.5L13.732 4c-.77-.833-1.732-.833-2.5 0L4.268 18.5c-.77.833.192 2.5 1.732 2.5z" />
                    </svg>
                </div>
                <h3 class="font-bold text-lg mb-2">No Models Available</h3>
                <p class="text-sm text-base-content/70 mb-4">Configure cloud providers or install local Ollama models to start testing.</p>
                <div class="flex gap-4 justify-center">
                    <a href="/settings/providers" class="btn btn-primary btn-sm">
                        <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.25 15a4.5 4.5 0 004.5 4.5H18a3.75 3.75 0 001.332-7.257 3 3 0 00-3.758-3.848 5.25 5.25 0 00-10.233 2.33A4.502 4.502 0 002.25 15z" />
                        </svg>
                        Add Cloud Providers
                    </a>
                    <div class="btn btn-ghost btn-sm">
                        Install Local: ollama pull llava-phi3:3.8b-mini-q4_0
                    </div>
                </div>
            </div>
            {% endif %}
            
            <div class="divider"></div>
            
            <div class="flex justify-between items-center">
                <div class="flex items-center gap-4">
                    <div class="text-sm text-base-content/70">
                        <span id="selected-count">0</span> models selected
                    </div>
                    <button class="btn btn-ghost btn-sm" onclick="refreshModels()" id="refresh-models-btn">
                        <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
                        </svg>
                        Refresh Models
                    </button>
                </div>
                <button class="btn btn-primary" onclick="runTests()" id="run-tests-btn" disabled>
                    <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                    Run Tests
                </button>
            </div>
        </div>
    </div>

    <!-- Results -->
    <div id="results-container" class="hidden">
        <h2 class="text-2xl font-bold mb-4">Test Results</h2>
        <div id="results-grid" class="grid grid-cols-1 lg:grid-cols-2 gap-6">
            <!-- Results will be inserted here -->
        </div>
        
        <!-- Performance Summary -->
        <div class="card bg-base-200 mt-8">
            <div class="card-body">
                <h3 class="card-title">Performance Summary</h3>
                <div id="performance-chart" class="h-64">
                    <!-- Chart will be inserted here -->
                </div>
            </div>
        </div>
    </div>
</div>

<style>
.model-available { color: var(--success); }
.model-unavailable { color: var(--error); }
.model-unknown { color: var(--warning); }
</style>

<script>
const selectedModels = new Set();
const detectionId = {{ detection.id }};
let testResults = {};

// Helper function to escape HTML for safe display
function escapeHtml(text) {
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// All displayed models are already installed, no need to check availability

async function refreshModels() {
    const refreshBtn = document.getElementById('refresh-models-btn');
    refreshBtn.disabled = true;
    refreshBtn.innerHTML = '<span class="loading loading-spinner loading-sm mr-1"></span>Refreshing...';
    
    try {
        const response = await fetch('/model-test/api/installed-models');
        const data = await response.json();
        
        if (data.models && data.models.length > 0) {
            // Reload the page with fresh model data
            window.location.reload();
        } else {
            // Show message if no models found
            alert('No vision models found. Install models with: ollama pull llava-phi3:3.8b-mini-q4_0');
        }
    } catch (error) {
        console.error('Error refreshing models:', error);
        alert('Failed to refresh models. Is Ollama running?');
    } finally {
        refreshBtn.disabled = false;
        refreshBtn.innerHTML = `
            <svg class="w-4 h-4 mr-1" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" />
            </svg>
            Refresh Models
        `;
    }
}

function toggleModel(checkbox) {
    if (checkbox.checked) {
        selectedModels.add(checkbox.value);
    } else {
        selectedModels.delete(checkbox.value);
    }
    
    document.getElementById('selected-count').textContent = selectedModels.size;
    document.getElementById('run-tests-btn').disabled = selectedModels.size === 0;
}

async function runTests() {
    if (selectedModels.size === 0) return;
    
    // Show results container
    document.getElementById('results-container').classList.remove('hidden');
    
    // Clear previous results
    document.getElementById('results-grid').innerHTML = '';
    testResults = {};
    
    // Disable run button
    const runBtn = document.getElementById('run-tests-btn');
    runBtn.disabled = true;
    runBtn.innerHTML = '<span class="loading loading-spinner loading-sm mr-2"></span>Running Tests...';
    
    // Run tests for each selected model
    for (const modelName of selectedModels) {
        await testModel(modelName);
    }
    
    // Re-enable button
    runBtn.disabled = false;
    runBtn.innerHTML = `
        <svg class="w-4 h-4 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
        </svg>
        Run Tests Again
    `;
    
    // Show performance summary
    showPerformanceSummary();
}

async function testModel(modelName) {
    // Create result card
    const resultCard = document.createElement('div');
    resultCard.className = 'card bg-base-100 shadow-xl';
    resultCard.innerHTML = `
        <div class="card-body">
            <h3 class="card-title">${modelName}</h3>
            <div class="text-center py-8">
                <span class="loading loading-spinner loading-lg"></span>
                <p class="mt-4">Testing model...</p>
            </div>
        </div>
    `;
    document.getElementById('results-grid').appendChild(resultCard);
    
    try {
        const startTime = Date.now();
        const response = await fetch('/model-test/api/test-model', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({
                detection_id: detectionId,
                model_name: modelName
            })
        });
        
        const data = await response.json();
        const endTime = Date.now();
        
        // Store result
        testResults[modelName] = data;
        
        // Update card with results
        if (data.success) {
            const warmupInfo = data.warmup_info || {};
            const wasLoaded = warmupInfo.model_was_loaded ? "‚úì Pre-loaded" : "üîÑ Cold start";
            
            resultCard.innerHTML = `
                <div class="card-body">
                    <div class="flex justify-between items-start mb-4">
                        <h3 class="card-title">${modelName}</h3>
                        <div class="flex flex-col items-end gap-1">
                            <div class="badge badge-success">${data.duration_formatted}</div>
                            <div class="text-xs text-base-content/60">${wasLoaded}</div>
                        </div>
                    </div>
                    
                    ${data.results && data.results.length > 0 ? `
                        <div class="space-y-4">
                            ${data.results.map((result, idx) => `
                                <div class="border rounded-lg p-4 ${result.error ? 'border-error bg-error/10' : 'border-base-300'}">
                                    ${result.error ? `
                                        <div class="text-error">Error: ${result.error}</div>
                                    ` : `
                                        <div class="flex gap-4 mb-4">
                                            <!-- Cropped Image Sent to Model -->
                                            ${result.cropped_image_url ? `
                                                <div class="flex-shrink-0">
                                                    <div class="w-24 h-24 bg-base-200 rounded-lg overflow-hidden border cursor-pointer hover:shadow-lg transition-shadow"
                                                         onclick="openImageModal('${result.cropped_image_url}')">
                                                        <img src="${result.cropped_image_url}" 
                                                             alt="Cropped image ${idx + 1}"
                                                             class="w-full h-full object-cover"
                                                             loading="lazy">
                                                    </div>
                                                    <div class="text-xs text-center text-base-content/60 mt-1">
                                                        ${result.crop_size || 'N/A'}
                                                    </div>
                                                </div>
                                            ` : ''}
                                            
                                            <!-- Results -->
                                            <div class="flex-1">
                                                ${result.result.identifications && result.result.identifications.length > 0 ? `
                                                    ${result.result.identifications.map(id => `
                                                        <div class="space-y-2">
                                                            <div class="flex justify-between items-start">
                                                                <div>
                                                                    <div class="font-bold">${id.species}</div>
                                                                    ${id.common_name ? `<div class="text-sm text-base-content/70">${id.common_name}</div>` : ''}
                                                                </div>
                                                                <div class="text-right">
                                                                    <div class="badge badge-primary">${Math.round(id.confidence * 100)}%</div>
                                                                    ${id.foe_type ? `<div class="badge badge-warning badge-sm ml-1">${id.foe_type}</div>` : ''}
                                                                </div>
                                                            </div>
                                                            ${id.description ? `<p class="text-sm">${id.description}</p>` : ''}
                                                            ${id.reasoning ? `
                                                                <details class="text-xs">
                                                                    <summary class="cursor-pointer text-primary hover:underline">Show reasoning</summary>
                                                                    <p class="mt-1 text-base-content/60">${id.reasoning}</p>
                                                                </details>
                                                            ` : ''}
                                                        </div>
                                                    `).join('')}
                                                ` : `
                                                    <div class="text-base-content/50">No species identified</div>
                                                `}
                                                
                                                ${result.result.raw_response ? (() => {
                                                    const escapedResponse = escapeHtml(result.result.raw_response);
                                                    return `
                                                        <details class="mt-3">
                                                            <summary class="cursor-pointer text-xs text-primary hover:underline">Show raw API response</summary>
                                                            <pre class="mt-2 p-2 bg-base-200 rounded text-xs overflow-x-auto whitespace-pre-wrap">${escapedResponse}</pre>
                                                        </details>
                                                    `;
                                                })() : ''}
                                                
                                                ${result.result.error ? `
                                                    <div class="mt-2 alert alert-error">
                                                        <div class="text-sm">${result.result.error}</div>
                                                    </div>
                                                ` : ''}
                                            </div>
                                        </div>
                                    `}
                                </div>
                            `).join('')}
                        </div>
                    ` : ''}
                    
                    <div class="mt-4 pt-4 border-t text-xs text-base-content/60">
                        <div class="grid grid-cols-2 gap-2">
                            <div>Inference: <span class="font-mono">${data.duration_seconds}s</span></div>
                            <div>Total: <span class="font-mono">${data.total_duration_seconds || data.duration_seconds}s</span></div>
                            ${warmupInfo.warmup_duration ? `<div>Warmup: <span class="font-mono">${warmupInfo.warmup_duration}s</span></div>` : ''}
                            ${warmupInfo.load_duration ? `<div>Load: <span class="font-mono">${warmupInfo.load_duration}s</span></div>` : ''}
                            ${data.cost_formatted ? `<div>Cost: <span class="font-mono text-accent">${data.cost_formatted}</span></div>` : ''}
                            ${modelName.startsWith('cloud:') ? `<div>Type: <span class="text-secondary">‚òÅÔ∏è Cloud</span></div>` : `<div>Type: <span class="text-primary">üñ•Ô∏è Local</span></div>`}
                        </div>
                    </div>
                </div>
            `;
        } else {
            resultCard.innerHTML = `
                <div class="card-body">
                    <h3 class="card-title text-error">${modelName}</h3>
                    <div class="alert alert-error">
                        <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span>${data.error || 'Test failed'}</span>
                    </div>
                </div>
            `;
        }
    } catch (error) {
        resultCard.innerHTML = `
            <div class="card-body">
                <h3 class="card-title text-error">${modelName}</h3>
                <div class="alert alert-error">
                    <span>Network error: ${error.message}</span>
                </div>
            </div>
        `;
    }
}

function showPerformanceSummary() {
    const chartContainer = document.getElementById('performance-chart');
    
    // Extract successful results
    const successfulTests = Object.entries(testResults)
        .filter(([_, result]) => result.success)
        .sort((a, b) => a[1].duration_seconds - b[1].duration_seconds);
    
    if (successfulTests.length === 0) {
        chartContainer.innerHTML = '<p class="text-center text-base-content/50">No successful tests to display</p>';
        return;
    }
    
    // Create simple bar chart
    const maxDuration = Math.max(...successfulTests.map(([_, r]) => r.duration_seconds));
    
    chartContainer.innerHTML = `
        <div class="space-y-3">
            ${successfulTests.map(([model, result]) => {
                const percentage = (result.duration_seconds / maxDuration) * 100;
                const speedup = successfulTests[successfulTests.length - 1][1].duration_seconds / result.duration_seconds;
                return `
                    <div>
                        <div class="flex justify-between text-sm mb-1">
                            <span class="font-medium">${model}</span>
                            <span>
                                ${result.duration_formatted} inference
                                ${speedup > 1.1 ? `(${speedup.toFixed(1)}x faster)` : ''}
                                ${result.warmup_info?.model_was_loaded ? ' ‚ö°' : ' üîÑ'}
                            </span>
                        </div>
                        <div class="w-full bg-base-300 rounded-full h-6">
                            <div class="bg-primary h-6 rounded-full flex items-center justify-end pr-2" style="width: ${percentage}%">
                                <span class="text-xs text-primary-content">${result.duration_seconds}s</span>
                            </div>
                        </div>
                    </div>
                `;
            }).join('')}
        </div>
        
        <div class="divider"></div>
        
        <div class="stats stats-vertical lg:stats-horizontal w-full">
            <div class="stat">
                <div class="stat-title">Fastest Model</div>
                <div class="stat-value text-lg">${successfulTests[0][0]}</div>
                <div class="stat-desc">${successfulTests[0][1].duration_formatted}</div>
            </div>
            
            <div class="stat">
                <div class="stat-title">Average Time</div>
                <div class="stat-value text-lg">${(successfulTests.reduce((acc, [_, r]) => acc + r.duration_seconds, 0) / successfulTests.length).toFixed(1)}s</div>
            </div>
            
            <div class="stat">
                <div class="stat-title">Speed Improvement</div>
                <div class="stat-value text-lg">${((successfulTests[successfulTests.length - 1][1].duration_seconds / successfulTests[0][1].duration_seconds - 1) * 100).toFixed(0)}%</div>
                <div class="stat-desc">vs slowest model</div>
            </div>
        </div>
    `;
}
</script>
{% endblock %}