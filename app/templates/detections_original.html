{% extends "base.html" %}

{% block content %}
<div class="container mx-auto px-4 pt-0 pb-2 max-w-7xl">
    <!-- Compact Header with Filters -->
    <div class="flex flex-col gap-4 mb-6">
        <div class="flex flex-col md:flex-row md:items-center md:justify-between gap-4">
            <h1 class="text-3xl font-bold">Detections</h1>
            
            <!-- Filters -->
            <form method="get" class="flex flex-wrap items-center gap-3">
                <select name="hours" class="select select-bordered select-sm">
                    <option value="1" {% if hours == 1 %}selected{% endif %}>Last Hour</option>
                    <option value="6" {% if hours == 6 %}selected{% endif %}>Last 6 Hours</option>
                    <option value="24" {% if hours == 24 %}selected{% endif %}>Last 24 Hours</option>
                    <option value="72" {% if hours == 72 %}selected{% endif %}>Last 3 Days</option>
                    <option value="168" {% if hours == 168 %}selected{% endif %}>Last Week</option>
                </select>
                
                <select name="foe_type" class="select select-bordered select-sm">
                    <option value="">All Types</option>
                    <option value="rats" {% if foe_type == "rats" %}selected{% endif %}>Rats</option>
                    <option value="crows" {% if foe_type == "crows" %}selected{% endif %}>Crows</option>
                    <option value="cats" {% if foe_type == "cats" %}selected{% endif %}>Cats</option>
                    <option value="unknown" {% if foe_type == "unknown" %}selected{% endif %}>Unknown</option>
                </select>
                
                <button type="submit" class="btn btn-primary btn-sm">Apply Filters</button>
            </form>
        </div>
        
        <!-- Detection Interval Control -->
        <div class="card bg-base-100 shadow-sm">
            <div class="card-body p-4">
                <div class="flex flex-col sm:flex-row sm:items-center gap-4">
                    <div class="flex items-center gap-2">
                        <svg class="w-5 h-5 text-base-content/70" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z" />
                        </svg>
                        <span class="font-medium">Detection Interval:</span>
                        <span id="interval-display" class="text-primary font-bold">{{ current_interval }}s</span>
                    </div>
                    
                    <div class="flex-1 max-w-xs">
                        <input 
                            type="range" 
                            id="interval-slider" 
                            min="1" 
                            max="30" 
                            value="{{ current_interval }}" 
                            class="range range-primary range-sm"
                            oninput="updateInterval(this.value)"
                        >
                        <div class="w-full flex justify-between text-xs px-2 mt-1">
                            <span>1s</span>
                            <span>15s</span>
                            <span>30s</span>
                        </div>
                    </div>
                    
                    <div class="text-sm text-base-content/70">
                        <span id="interval-status">Current: Every {{ current_interval }} seconds</span>
                    </div>
                </div>
                
            </div>
        </div>
    </div>
    
    <!-- Action Buttons -->
    {% if detections %}
    <div class="flex justify-end mb-4">
        <button onclick="clearAllModal.showModal()" class="btn btn-error btn-sm">
            <svg class="w-4 h-4" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" />
            </svg>
            Clear All
        </button>
    </div>
    {% endif %}
    
    <!-- Detections Grid -->
    {% if detections %}
    <div class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 gap-4">
        {% for detection in detections %}
        <div class="card bg-base-100 shadow-sm hover:shadow-md transition-shadow">
            <!-- Detection Image -->
            {% if detection.image_path %}
            <figure class="aspect-[4/3] bg-base-200">
                <img 
                    src="/{{ detection.image_path }}" 
                    alt="Detection {{ detection.id }}"
                    class="w-full h-full object-cover"
                    onerror="this.onerror=null;this.src='/static/img/no-image.png';"
                />
                <!-- Foe badges overlay -->
                {% if detection.foes %}
                <div class="absolute top-2 left-2 flex flex-wrap gap-1">
                    {% for foe in detection.foes %}
                    <span class="badge 
                        {% if foe.foe_type == 'rats' %}badge-error
                        {% elif foe.foe_type == 'crows' %}badge-warning
                        {% elif foe.foe_type == 'cats' %}badge-success
                        {% else %}badge-neutral{% endif %} 
                        badge-sm">
                        {{ foe.foe_type.title() }}
                        <span class="ml-1 opacity-70">{{ "%.0f%%" | format(foe.confidence * 100) }}</span>
                    </span>
                    {% endfor %}
                </div>
                {% endif %}
            </figure>
            {% endif %}
            
            <div class="card-body p-4">
                <!-- Camera Info -->
                <h3 class="font-semibold text-sm mb-1">
                    {{ detection.device.name if detection.device else 'Unknown Camera' }}
                </h3>
                
                <!-- Timestamp -->
                <p class="text-xs text-base-content/70 mb-2">
                    {{ detection.timestamp.strftime('%Y-%m-%d %H:%M:%S') }}
                </p>
                
                <!-- Scene Description -->
                {% if detection.ai_response and detection.ai_response.scene_description %}
                <p class="text-sm text-base-content/80 line-clamp-2">
                    {{ detection.ai_response.scene_description }}
                </p>
                {% endif %}
                
                <!-- Status Badge -->
                <div class="mt-2">
                    <span class="badge badge-xs 
                        {% if detection.status == 'processed' %}badge-success
                        {% elif detection.status == 'pending' %}badge-warning
                        {% elif detection.status == 'deterred' %}badge-info
                        {% else %}badge-error{% endif %}">
                        {{ detection.status }}
                    </span>
                </div>
            </div>
        </div>
        {% endfor %}
    </div>
    {% else %}
    <!-- Empty State -->
    <div class="card bg-base-100 shadow-sm">
        <div class="card-body text-center py-16">
            <div class="max-w-md mx-auto">
                <svg class="w-24 h-24 mx-auto mb-4 text-base-content/20" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 17v1a3 3 0 003 3h0a3 3 0 003-3v-1m-6 0h6m-6 0H6a2 2 0 01-2-2V7a2 2 0 012-2h1m8 10h3a2 2 0 002-2V7a2 2 0 00-2-2h-1m-8 0V3a1 1 0 011-1h4a1 1 0 011 1v2m-6 0h6" />
                </svg>
                <h3 class="text-lg font-semibold mb-2">No Detections Found</h3>
                <p class="text-base-content/70 mb-4">
                    No foes have been detected in the selected time range.
                </p>
                <p class="text-sm text-base-content/50">
                    The detection worker runs every <span id="worker-interval">{{ current_interval }}</span> seconds to check all active cameras.
                </p>
            </div>
        </div>
    </div>
    {% endif %}
    
    <!-- Detection count at bottom -->
    <div class="text-center mt-6 text-sm text-base-content/70">
        Showing {{ detections|length }} detection(s)
    </div>
</div>

<style>
.line-clamp-2 {
    display: -webkit-box;
    -webkit-line-clamp: 2;
    -webkit-box-orient: vertical;
    overflow: hidden;
}
</style>

<!-- Clear All Confirmation Modal -->
<dialog id="clearAllModal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">Clear All Detections?</h3>
        <p class="py-4">
            This will permanently delete all {{ detections|length }} detection records. This action cannot be undone.
        </p>
        <div class="modal-action">
            <form method="post" action="/detections/clear-all">
                <button type="submit" class="btn btn-error">Yes, Clear All</button>
            </form>
            <form method="dialog">
                <button class="btn">Cancel</button>
            </form>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
let updateTimeout;

async function updateInterval(value) {
    // Update UI immediately for responsiveness
    document.getElementById('interval-display').textContent = value + 's';
    document.getElementById('interval-status').textContent = `Current: Every ${value} seconds`;
    document.getElementById('worker-interval').textContent = value;
    
    // Clear previous timeout to debounce API calls
    clearTimeout(updateTimeout);
    
    // Set a new timeout to make the API call after user stops dragging
    updateTimeout = setTimeout(async () => {
        try {
            const response = await fetch('/detections/api/interval', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({ interval: parseInt(value) })
            });
            
            if (response.ok) {
                const result = await response.json();
                console.log('Interval updated:', result.message);
                
                // Show brief success feedback
                const statusElement = document.getElementById('interval-status');
                const originalText = statusElement.textContent;
                statusElement.textContent = '✓ Updated successfully';
                statusElement.className = 'text-sm text-success';
                
                setTimeout(() => {
                    statusElement.textContent = originalText;
                    statusElement.className = 'text-sm text-base-content/70';
                }, 2000);
            } else {
                console.error('Failed to update interval');
                // Show error feedback
                const statusElement = document.getElementById('interval-status');
                statusElement.textContent = '✗ Update failed';
                statusElement.className = 'text-sm text-error';
                
                setTimeout(() => {
                    statusElement.textContent = `Current: Every ${value} seconds`;
                    statusElement.className = 'text-sm text-base-content/70';
                }, 2000);
            }
        } catch (error) {
            console.error('Error updating interval:', error);
        }
    }, 500); // Wait 500ms after user stops moving the slider
}

</script>
{% endblock %}