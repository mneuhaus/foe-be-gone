{% extends "base.html" %}

{% block title %}Integrations{% endblock %}

{% block content %}
<div class="max-w-4xl mx-auto">
    <div class="flex justify-between items-center mb-6">
        <h1 class="text-3xl font-bold">Integrations</h1>
        
        <!-- Add Integration Button with Dropdown -->
        <div class="dropdown dropdown-end">
            <div tabindex="0" role="button" class="btn btn-primary">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 mr-2">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
                </svg>
                Add Integration
            </div>
            <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded z-[1] w-64 p-2 shadow-lg">
                <li>
                    <a href="#" onclick="addIntegration('dummy-surveillance'); return false;">
                        <div>
                            <div class="font-semibold">Dummy Surveillance</div>
                            <div class="text-xs opacity-70">Test integration for development</div>
                        </div>
                    </a>
                </li>
                <li>
                    <a href="#" onclick="showUniFiConfigModal(); return false;">
                        <div>
                            <div class="font-semibold">UniFi Protect</div>
                            <div class="text-xs opacity-70">Connect to UniFi Protect cameras</div>
                        </div>
                    </a>
                </li>
            </ul>
        </div>
    </div>
    
    <!-- Active Integrations List -->
    <div class="space-y-4">
        {% if integrations %}
            {% for integration in integrations %}
            <div class="card bg-base-200 shadow-sm">
                <div class="card-body">
                    <div class="flex items-center justify-between">
                        <div>
                            <h3 class="card-title text-lg">{{ integration.name }}</h3>
                        </div>
                        <div class="flex items-center gap-4">
                            <!-- Status indicator -->
                            <div class="flex items-center gap-2">
                                {% if integration.status == "connected" %}
                                    <div class="w-2 h-2 bg-success rounded-full"></div>
                                {% elif integration.status == "error" %}
                                    <div class="w-2 h-2 bg-error rounded-full"></div>
                                {% else %}
                                    <div class="w-2 h-2 bg-warning rounded-full"></div>
                                {% endif %}
                            </div>
                            
                            <!-- Test Scenarios Dropdown (for dummy integrations) -->
                            {% if integration.integration_type == "dummy-surveillance" %}
                            <div class="dropdown dropdown-end" id="test-dropdown-{{ integration.id }}">
                                <div tabindex="0" role="button" class="btn btn-sm btn-outline">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 15.75l5.159-5.159a2.25 2.25 0 013.182 0l5.159 5.159m-1.5-1.5l1.409-1.409a2.25 2.25 0 013.182 0l2.909 2.909m-18 3.75h16.5a1.5 1.5 0 001.5-1.5V6a1.5 1.5 0 00-1.5-1.5H3.75A1.5 1.5 0 002.25 6v12a1.5 1.5 0 001.5 1.5zm10.5-11.25h.008v.008h-.008V8.25zm.375 0a.375.375 0 11-.75 0 .375.375 0 01.75 0z" />
                                    </svg>
                                    Test Scenario
                                </div>
                                <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded z-[1] w-48 p-2 shadow-lg" id="scenarios-{{ integration.id }}">
                                    <li><a class="loading">Loading scenarios...</a></li>
                                </ul>
                            </div>
                            {% endif %}
                            
                            <!-- Actions -->
                            <div class="dropdown dropdown-end">
                                <div tabindex="0" role="button" class="btn btn-ghost btn-sm btn-circle">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 12.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5ZM12 18.75a.75.75 0 1 1 0-1.5.75.75 0 0 1 0 1.5Z" />
                                    </svg>
                                </div>
                                <ul tabindex="0" class="dropdown-content menu bg-base-100 rounded z-[1] w-48 p-2 shadow">
                                    <li><a onclick="testIntegration('{{ integration.id }}')">Test Connection</a></li>
                                    {% if integration.integration_type == "unifi_protect" and integration.status == "connected" %}
                                    <li><a onclick="showCameraSelectionModal('{{ integration.id }}')">Select Cameras</a></li>
                                    {% endif %}
                                    <li><a onclick="deleteIntegration('{{ integration.id }}')" class="text-error">Delete</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    
                    
                    <!-- Device Cards -->
                    {% if integration.devices %}
                    <div class="flex gap-3 mt-4 flex-wrap">
                        {% for device in integration.devices %}
                        <div class="card bg-base-100 shadow-sm w-48" id="device-{{ device.id }}">
                            <figure class="p-2 relative">
                                {% if device.device_type == "camera" %}
                                    {% if integration.integration_type == "unifi_protect" and device.current_image_url %}
                                        <img 
                                            src="{{ device.current_image_url }}" 
                                            alt="{{ device.name }}" 
                                            class="rounded h-24 w-full object-cover device-image"
                                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                        />
                                        <div class="bg-base-200 rounded h-24 w-full flex items-center justify-center" style="display:none;">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 opacity-50">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 0 0-1.134-.175 2.31 2.31 0 0 1-1.64-1.055l-.822-1.316a2.192 2.192 0 0 0-1.736-1.039 48.774 48.774 0 0 0-5.232 0 2.192 2.192 0 0 0-1.736 1.039l-.821 1.316Z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM18.75 10.5h.008v.008h-.008V10.5Z" />
                                            </svg>
                                        </div>
                                        <div class="bg-base-200 rounded h-24 w-full flex items-center justify-center" style="display:none;">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 opacity-50">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 0 0-1.134-.175 2.31 2.31 0 0 1-1.64-1.055l-.822-1.316a2.192 2.192 0 0 0-1.736-1.039 48.774 48.774 0 0 0-5.232 0 2.192 2.192 0 0 0-1.736 1.039l-.821 1.316Z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM18.75 10.5h.008v.008h-.008V10.5Z" />
                                            </svg>
                                        </div>
                                    {% elif device.current_image_url %}
                                        <img 
                                            src="{{ device.current_image_url }}" 
                                            alt="{{ device.name }}" 
                                            class="rounded h-24 w-full object-cover device-image"
                                            onerror="this.style.display='none'; this.nextElementSibling.style.display='flex';"
                                        />
                                        <div class="bg-base-200 rounded h-24 w-full flex items-center justify-center" style="display:none;">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 opacity-50">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 0 0-1.134-.175 2.31 2.31 0 0 1-1.64-1.055l-.822-1.316a2.192 2.192 0 0 0-1.736-1.039 48.774 48.774 0 0 0-5.232 0 2.192 2.192 0 0 0-1.736 1.039l-.821 1.316Z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM18.75 10.5h.008v.008h-.008V10.5Z" />
                                            </svg>
                                        </div>
                                    {% else %}
                                        <div class="bg-base-200 rounded h-24 w-full flex items-center justify-center">
                                            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 opacity-50">
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 0 0-1.134-.175 2.31 2.31 0 0 1-1.64-1.055l-.822-1.316a2.192 2.192 0 0 0-1.736-1.039 48.774 48.774 0 0 0-5.232 0 2.192 2.192 0 0 0-1.736 1.039l-.821 1.316Z" />
                                                <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM18.75 10.5h.008v.008h-.008V10.5Z" />
                                            </svg>
                                        </div>
                                    {% endif %}
                                {% else %}
                                <div class="bg-base-200 rounded h-24 w-full flex items-center justify-center">
                                    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 opacity-50">
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M6.827 6.175A2.31 2.31 0 0 1 5.186 7.23c-.38.054-.757.112-1.134.175C2.999 7.58 2.25 8.507 2.25 9.574V18a2.25 2.25 0 0 0 2.25 2.25h15A2.25 2.25 0 0 0 21.75 18V9.574c0-1.067-.75-1.994-1.802-2.169a47.865 47.865 0 0 0-1.134-.175 2.31 2.31 0 0 1-1.64-1.055l-.822-1.316a2.192 2.192 0 0 0-1.736-1.039 48.774 48.774 0 0 0-5.232 0 2.192 2.192 0 0 0-1.736 1.039l-.821 1.316Z" />
                                        <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 12.75a4.5 4.5 0 1 1-9 0 4.5 4.5 0 0 1 9 0ZM18.75 10.5h.008v.008h-.008V10.5Z" />
                                    </svg>
                                </div>
                                {% endif %}
                                
                            </figure>
                            <div class="card-body p-3 pt-0">
                                <div class="flex items-center justify-between">
                                    <p class="text-xs font-medium flex-1">{{ device.name }}</p>
                                    <!-- Talkback speaker icon for UniFi cameras -->
                                    {% if integration.integration_type == "unifi_protect" and device.device_type == "camera" %}
                                    <button onclick="testTalkback('{{ integration.id }}', '{{ device.id }}')" 
                                            class="btn btn-circle btn-xs btn-primary ml-2">
                                        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-3 h-3">
                                            <path stroke-linecap="round" stroke-linejoin="round" d="M19.114 5.636a9 9 0 010 12.728M16.463 8.288a5.25 5.25 0 010 7.424M6.75 8.25l4.72-4.72a.75.75 0 011.28.53v15.88a.75.75 0 01-1.28.53l-4.72-4.72H4.51c-.88 0-1.704-.507-1.938-1.354A9.01 9.01 0 012.25 12c0-.83.112-1.633.322-2.396C2.806 8.756 3.63 8.25 4.51 8.25H6.75z" />
                                        </svg>
                                    </button>
                                    {% endif %}
                                </div>
                            </div>
                        </div>
                        {% endfor %}
                    </div>
                    {% endif %}
                </div>
            </div>
            {% endfor %}
        {% else %}
            <div class="text-center py-12">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 mx-auto mb-4 opacity-50">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M13.828 10.172a4 4 0 0 0-5.656 0l-4 4a4 4 0 1 0 5.656 5.656l1.102-1.101m-.758-4.899a4 4 0 0 0 5.656 0l4-4a4 4 0 0 0-5.656-5.656l-1.1 1.1" />
                </svg>
                <p class="text-lg mb-2">No integrations configured</p>
                <p class="text-sm opacity-70">Add an integration to start connecting your devices</p>
            </div>
        {% endif %}
    </div>
</div>

<!-- Camera Selection Modal -->
<dialog id="camera-selection-modal" class="modal">
    <div class="modal-box max-w-2xl">
        <h3 class="font-bold text-lg mb-4">Select Cameras</h3>
        <div id="camera-selection-content">
            <div class="text-center py-8">
                <span class="loading loading-spinner loading-lg"></span>
                <p class="mt-2">Loading cameras...</p>
            </div>
        </div>
        <div class="modal-action">
            <button type="button" class="btn" onclick="document.getElementById('camera-selection-modal').close()">Cancel</button>
            <button type="button" class="btn btn-primary" onclick="saveCameraSelection()">Save Selection</button>
        </div>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<!-- UniFi Protect Configuration Modal -->
<dialog id="unifi-config-modal" class="modal">
    <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">Configure UniFi Protect</h3>
        <form id="unifi-config-form" class="space-y-4">
            <div class="form-control">
                <label class="label">
                    <span class="label-text">UniFi Protect Host</span>
                </label>
                <input 
                    type="text" 
                    name="host" 
                    placeholder="https://192.168.1.1" 
                    class="input input-bordered" 
                    required
                />
                <label class="label">
                    <span class="label-text-alt">Include https:// and your UniFi controller IP/hostname</span>
                </label>
            </div>
            
            <div class="form-control">
                <label class="label">
                    <span class="label-text">API Key</span>
                </label>
                <input 
                    type="password" 
                    name="api_key" 
                    placeholder="Enter your UniFi Protect API key" 
                    class="input input-bordered" 
                    required
                />
                <label class="label">
                    <span class="label-text-alt">Generate from UniFi Protect Settings → Integrations</span>
                </label>
            </div>
            
            <div class="modal-action">
                <button type="button" class="btn" onclick="document.getElementById('unifi-config-modal').close()">Cancel</button>
                <button type="submit" class="btn btn-primary">Connect</button>
            </div>
        </form>
    </div>
    <form method="dialog" class="modal-backdrop">
        <button>close</button>
    </form>
</dialog>

<script>
// Simple notification system
function showNotification(message, type = 'info') {
    const colors = {
        'success': 'alert-success',
        'error': 'alert-error',
        'warning': 'alert-warning',
        'info': 'alert-info'
    };
    
    const notification = document.createElement('div');
    notification.className = `alert ${colors[type]} fixed top-4 right-4 z-50 max-w-sm shadow-lg`;
    notification.innerHTML = `
        <span>${message}</span>
    `;
    
    document.body.appendChild(notification);
    
    // Auto-remove after 3 seconds
    setTimeout(() => {
        notification.remove();
    }, 3000);
}

async function addIntegration(integrationType) {
    try {
        const response = await fetch('/api/integrations', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                integration_type: integrationType,
                name: `${integrationType} ${new Date().toLocaleString()}`
            })
        });
        
        if (response.ok) {
            // Reload the page to show the new integration
            window.location.reload();
        } else {
            showNotification('Failed to add integration', 'error');
        }
    } catch (error) {
        console.error('Error adding integration:', error);
        showNotification('Error adding integration', 'error');
    }
}

async function testIntegration(integrationId) {
    try {
        const response = await fetch(`/api/integrations/${integrationId}/test`, {
            method: 'POST'
        });
        
        if (response.ok) {
            const result = await response.json();
            showNotification(`Test ${result.success ? 'passed' : 'failed'}: ${result.message}`, result.success ? 'success' : 'error');
        } else {
            showNotification('Failed to test integration', 'error');
        }
    } catch (error) {
        console.error('Error testing integration:', error);
        showNotification('Error testing integration', 'error');
    }
}

async function deleteIntegration(integrationId) {
    if (!confirm('Are you sure you want to delete this integration?')) {
        return;
    }
    
    try {
        const response = await fetch(`/api/integrations/${integrationId}`, {
            method: 'DELETE'
        });
        
        if (response.ok) {
            window.location.reload();
        } else {
            showNotification('Failed to delete integration', 'error');
        }
    } catch (error) {
        console.error('Error deleting integration:', error);
        showNotification('Error deleting integration', 'error');
    }
}

async function setTestScenario(integrationId, scenario) {
    try {
        const response = await fetch(`/api/integrations/${integrationId}/test-scenario/${scenario}`, {
            method: 'POST'
        });
        
        if (response.ok) {
            const result = await response.json();
            // Show success message
            const message = `Set to "${scenario}" scenario (${result.image_count} images available)`;
            
            // Update device images
            const dropdown = document.getElementById(`test-dropdown-${integrationId}`);
            const integrationCard = dropdown.closest('.card');
            if (integrationCard && result.image_path) {
                const deviceImages = integrationCard.querySelectorAll('.device-image');
                deviceImages.forEach(img => {
                    // Force reload by adding timestamp
                    const newSrc = result.image_path + '?t=' + Date.now();
                    img.src = newSrc;
                });
            }
            
            console.log(message, result);
        } else {
            const error = await response.json();
            showNotification(`Failed to set scenario: ${error.detail}`, 'error');
        }
    } catch (error) {
        console.error('Error setting test scenario:', error);
        showNotification('Error setting test scenario', 'error');
    }
}

// Load test scenarios when dropdown is clicked
document.addEventListener('DOMContentLoaded', function() {
    // Find all test scenario dropdowns
    const testDropdowns = document.querySelectorAll('[id^="test-dropdown-"]');
    
    testDropdowns.forEach(dropdown => {
        const integrationId = dropdown.id.replace('test-dropdown-', '');
        const scenariosList = document.getElementById(`scenarios-${integrationId}`);
        
        dropdown.addEventListener('click', async function() {
            // Only load once
            if (scenariosList.dataset.loaded) return;
            
            try {
                const response = await fetch(`/api/integrations/${integrationId}/test-scenarios`);
                if (response.ok) {
                    const data = await response.json();
                    scenariosList.innerHTML = '';
                    
                    data.scenarios.forEach(scenario => {
                        const li = document.createElement('li');
                        const a = document.createElement('a');
                        a.textContent = scenario.charAt(0).toUpperCase() + scenario.slice(1).replace('-', ' ');
                        a.onclick = async () => {
                            await setTestScenario(integrationId, scenario);
                        };
                        li.appendChild(a);
                        scenariosList.appendChild(li);
                    });
                    
                    scenariosList.dataset.loaded = 'true';
                }
            } catch (error) {
                console.error('Error loading test scenarios:', error);
                scenariosList.innerHTML = '<li><a class="text-error">Failed to load</a></li>';
            }
        });
    });
});

// UniFi Protect configuration
function showUniFiConfigModal() {
    document.getElementById('unifi-config-modal').showModal();
}

// Camera selection
let currentIntegrationId = null;

async function showCameraSelectionModal(integrationId) {
    currentIntegrationId = integrationId;
    const modal = document.getElementById('camera-selection-modal');
    const content = document.getElementById('camera-selection-content');
    
    // Show loading state
    content.innerHTML = `
        <div class="text-center py-8">
            <span class="loading loading-spinner loading-lg"></span>
            <p class="mt-2">Loading cameras...</p>
        </div>
    `;
    
    modal.showModal();
    
    try {
        // Fetch available cameras from UniFi
        const response = await fetch(`/api/integrations/${integrationId}/cameras`);
        if (!response.ok) {
            throw new Error('Failed to fetch cameras');
        }
        
        const data = await response.json();
        
        // Render camera selection grid
        content.innerHTML = `
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                ${data.cameras.map(camera => `
                    <label class="card bg-base-200 cursor-pointer hover:bg-base-300 transition-colors">
                        <div class="card-body p-4">
                            <div class="flex items-start gap-3">
                                <input 
                                    type="checkbox" 
                                    class="checkbox checkbox-primary mt-1" 
                                    name="camera"
                                    value="${camera.id}"
                                    ${camera.enabled ? 'checked' : ''}
                                />
                                <div class="flex-1">
                                    <h4 class="font-semibold">${camera.name}</h4>
                                </div>
                            </div>
                        </div>
                    </label>
                `).join('')}
            </div>
        `;
        
        // Show message if no cameras found
        if (data.cameras.length === 0) {
            content.innerHTML = `
                <div class="text-center py-8">
                    <p class="text-lg">No cameras found</p>
                    <p class="text-sm opacity-70 mt-2">Make sure your UniFi Protect system has cameras configured</p>
                </div>
            `;
        }
    } catch (error) {
        content.innerHTML = `
            <div class="alert alert-error">
                <span>Error loading cameras: ${error.message}</span>
            </div>
        `;
    }
}

async function saveCameraSelection() {
    if (!currentIntegrationId) return;
    
    // Get selected cameras
    const checkboxes = document.querySelectorAll('#camera-selection-content input[name="camera"]:checked');
    const selectedCameras = Array.from(checkboxes).map(cb => cb.value);
    
    try {
        const response = await fetch(`/api/integrations/${currentIntegrationId}/cameras`, {
            method: 'PUT',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                enabled_cameras: selectedCameras
            })
        });
        
        if (response.ok) {
            document.getElementById('camera-selection-modal').close();
            showNotification('Camera selection saved', 'success');
            // Always reload to show the updated cameras
            setTimeout(() => {
                window.location.reload();
            }, 500);
        } else {
            const error = await response.json();
            showNotification(`Failed to save: ${error.detail}`, 'error');
        }
    } catch (error) {
        showNotification('Error saving camera selection', 'error');
    }
}

async function testTalkback(integrationId, deviceId) {
    try {
        const response = await fetch(`/api/integrations/${integrationId}/devices/${deviceId}/talkback`, {
            method: 'POST'
        });
        
        const result = await response.json();
        
        if (result.success) {
            showNotification('Talkback test initiated', 'success');
        } else {
            showNotification(result.message || 'Talkback test failed', 'error');
        }
    } catch (error) {
        console.error('Error testing talkback:', error);
        showNotification('Error testing talkback', 'error');
    }
}

document.getElementById('unifi-config-form').addEventListener('submit', async function(e) {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const config = {
        host: formData.get('host'),
        api_key: formData.get('api_key')
    };
    
    try {
        // Create the integration with configuration
        const response = await fetch('/api/integrations', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({
                integration_type: 'unifi_protect',
                name: 'UniFi Protect',
                config: config
            })
        });
        
        if (response.ok) {
            const integration = await response.json();
            document.getElementById('unifi-config-modal').close();
            
            // For UniFi integrations, automatically open camera selection
            if (integration.integration_type === 'unifi_protect') {
                // Wait a moment for the modal to close
                setTimeout(() => {
                    showCameraSelectionModal(integration.id);
                }, 500);
            } else {
                window.location.reload();
            }
        } else {
            const error = await response.json();
            showNotification(`Failed to add UniFi Protect: ${error.detail || 'Unknown error'}`, 'error');
        }
    } catch (error) {
        console.error('Error adding UniFi Protect:', error);
        showNotification('Error adding UniFi Protect integration', 'error');
    }
});
</script>
{% endblock %}